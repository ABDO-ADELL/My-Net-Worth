@model IEnumerable<Expense>

@{
    ViewData["Title"] = "Expenses";
}

<div class="container-fluid mt-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">
            <i class="fas fa-money-bill-wave text-danger me-2"></i>All Expenses
        </h2>
        <div class="d-flex gap-2">
            <a asp-action="Create" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add New Expense
            </a>
        </div>
    </div>

    @if (ViewBag.NoBusiness == true)
    {
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            No business found. Please create a business first.
        </div>
    }
    else
    {
        <!-- Filters Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Filters
                </h5>
            </div>
            <div class="card-body">
                <form asp-action="Index" method="get" class="row g-3" id="filterForm">

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Business</label>
                        <select name="businessId" class="form-select" id="businessFilter">
                            @if (ViewBag.Businesses != null)
                            {
                                @foreach (var item in (SelectList)ViewBag.Businesses)
                                {
                                    <option value="@item.Value" selected="@item.Selected">@item.Text</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Branch</label>
                        <select name="branchId" class="form-select" id="branchFilter">
                            <option value="">All Branches</option>
                            @if (ViewBag.Branches != null)
                            {
                                @foreach (var item in (SelectList)ViewBag.Branches)
                                {
                                    <option value="@item.Value" selected="@item.Selected">@item.Text</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Category</label>
                        <select name="category" class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            @if (ViewBag.Categories != null)
                            {
                                @foreach (var cat in (List<string>)ViewBag.Categories)
                                {
                                    <option value="@cat" selected="@(cat == ViewBag.Category)">@cat</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Start Date</label>
                        <input type="date" name="startDate" class="form-control" value="@ViewBag.StartDate?.ToString("yyyy-MM-dd")" />
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-semibold">End Date</label>
                        <input type="date" name="endDate" class="form-control" value="@ViewBag.EndDate?.ToString("yyyy-MM-dd")" />
                    </div>

                    <div class="col-md-1 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>
                <div class="mt-3">
                    <a asp-action="Index" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-redo me-2"></i>Clear Filters
                    </a>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        @if (Model != null && Model.Any())
        {
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">Total Expenses</h6>
                            <h3 class="fw-bold text-danger mb-0">EGP @Model.Sum(e => e.Amount).ToString("N2")</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">Total Records</h6>
                            <h3 class="fw-bold text-info mb-0">@Model.Count()</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">Businesses</h6>
                            <h3 class="fw-bold text-primary mb-0">@Model.Select(e => e.BusinessId).Distinct().Count()</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">Categories</h6>
                            <h3 class="fw-bold text-warning mb-0">@Model.Where(e => !string.IsNullOrEmpty(e.Category)).Select(e => e.Category).Distinct().Count()</h3>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Expenses Table -->
        <div class="card shadow-sm">
            <div class="card-body">
                @if (Model != null && Model.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Business</th>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Branch</th>
                                    <th>Payment Method</th>
                                    <th class="text-end">Amount</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var expense in Model)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="icon-circle bg-primary-light me-2">
                                                    <i class="fas fa-building text-primary"></i>
                                                </div>
                                                <div>
                                                    <strong>@expense.Business?.Name</strong>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                <i class="far fa-calendar me-1"></i>
                                                @expense.ExpenseDate.ToString("dd MMM yyyy")
                                            </small>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(expense.Category))
                                            {
                                                <span class="badge bg-info">@expense.Category</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Uncategorized</span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(expense.Description))
                                            {
                                                <span title="@expense.Description">
                                                    @(expense.Description.Length > 40 ? expense.Description.Substring(0, 40) + "..." : expense.Description)
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-muted fst-italic">No description</span>
                                            }
                                        </td>
                                        <td>
                                            @if (expense.Branch != null)
                                            {
                                                <small>
                                                    <i class="fas fa-map-marker-alt me-1"></i>
                                                    @expense.Branch.Name
                                                </small>
                                            }
                                            else
                                            {
                                                <small class="text-muted">General</small>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-credit-card me-1"></i>
                                                @expense.PaymentMethod
                                            </span>
                                        </td>
                                        <td class="text-end">
                                            <strong class="text-danger fs-6">EGP @expense.Amount.ToString("N2")</strong>
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a asp-action="Details" asp-route-id="@expense.ExpenseId"
                                                   class="btn btn-outline-info" title="Details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a asp-action="Edit" asp-route-id="@expense.ExpenseId"
                                                   class="btn btn-outline-primary" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a asp-action="Delete" asp-route-id="@expense.ExpenseId"
                                                   class="btn btn-outline-danger" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="6" class="text-end fw-bold fs-5">Grand Total:</td>
                                    <td class="text-end fw-bold text-danger fs-5">
                                        EGP @Model.Sum(e => e.Amount).ToString("N2")
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="fas fa-receipt fa-4x text-muted mb-3 opacity-50"></i>
                        <h5 class="text-muted">No Expenses Found</h5>
                        <p class="text-muted">
                            @if (ViewBag.BusinessId != null)
                            {
                                <span>No expenses found for the selected filters. Try adjusting your search.</span>
                            }
                            else
                            {
                                <span>Start by adding your first expense</span>
                            }
                        </p>
                        <a asp-action="Create" class="btn btn-primary mt-3">
                            <i class="fas fa-plus me-2"></i>Add Expense
                        </a>
                    </div>
                }
            </div>
        </div>

        <!-- Expense Breakdown by Business -->
        @if (Model != null && Model.Any() && ViewBag.BusinessId == null)
        {
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Breakdown by Business
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        @{
                            var groupedByBusiness = Model.GroupBy(e => new { e.BusinessId, e.Business.Name })
                            .Select(g => new { Business = g.Key.Name, Total = g.Sum(e => e.Amount), Count = g.Count() })
                            .OrderByDescending(x => x.Total);
                        }
                        @foreach (var group in groupedByBusiness)
                        {
                            <div class="col-md-4">
                                <div class="card border-start border-primary border-4">
                                    <div class="card-body">
                                        <h6 class="fw-bold mb-2">@group.Business</h6>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <small class="text-muted">Total Amount</small>
                                                <h4 class="fw-bold text-danger mb-0">EGP @group.Total.ToString("N2")</h4>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">Expenses</small>
                                                <h4 class="fw-bold text-info mb-0">@group.Count</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Auto-submit on business change and load branches
            $('#businessFilter').change(function() {
                var businessId = $(this).val();

                if (businessId) {
                    // Load branches for selected business
                    $.ajax({
                        url: '@Url.Action("GetBranchesByBusiness", "Expenses")',
                        type: 'GET',
                        data: { businessId: businessId },
                        success: function(branches) {
                            var branchSelect = $('#branchFilter');
                            branchSelect.empty();
                            branchSelect.append('<option value="">All Branches</option>');

                            $.each(branches, function(i, branch) {
                                branchSelect.append($('<option></option>')
                                    .attr('value', branch.value)
                                    .text(branch.text));
                            });
                        }
                    });
                }

                // Auto-submit form
                $('#filterForm').submit();
            });
        });
    </script>
}

<style>
    .table th {
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    .btn-group-sm > .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .card {
        border-radius: 12px;
        border: none;
    }

    .icon-circle {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
    }

    .bg-primary-light {
        background-color: rgba(13, 110, 253, 0.1);
    }

    .table > :not(caption) > * > * {
        padding: 0.75rem 0.5rem;
    }

    .badge {
        padding: 0.35rem 0.65rem;
        font-weight: 500;
    }
</style>