@model DashboardViewModel

@{
    ViewData["Title"] = "Dashboard";
    var profitMargin = Model.TotalRevenue > 0 ? (Model.TotalProfit / Model.TotalRevenue * 100) : 0;
}

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-1"><i class="fas fa-chart-line me-2 text-primary"></i>Dashboard Overview</h2>
        <p class="text-muted mb-0">Real-time business performance metrics</p>
    </div>
    <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-building me-2"></i>Select Business
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
            @foreach (var business in ViewBag.Businesses)
            {
                <li>
                    <a class="dropdown-item @(business.BusinessId == ViewBag.SelectedBusinessId ? "active" : "")"
                       href="@Url.Action("Index", "Dashboard", new { businessId = business.BusinessId })">
                        @business.Name
                    </a>
                </li>
            }
        </ul>
    </div>
</div>

@if (ViewBag.NoBusiness == true)
{
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>No Business Found.</strong> Create your first business to get started.
        <a asp-controller="Business" asp-action="Create" class="btn btn-warning btn-sm ms-3">Create Business</a>
    </div>
}
else
{
    <!-- KPI Cards -->
    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="kpi-card">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="kpi-icon bg-success"><i class="fas fa-dollar-sign"></i></div>
                </div>
                <div class="kpi-label">Total Revenue</div>
                <div class="kpi-value">$@Model.TotalRevenue.ToString("N2")</div>
                <small class="text-muted">From completed orders</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="kpi-card">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="kpi-icon bg-danger"><i class="fas fa-money-bill-wave"></i></div>
                </div>
                <div class="kpi-label">Total Expenses</div>
                <div class="kpi-value">$@Model.TotalExpenses.ToString("N2")</div>
                <small class="text-muted">Business expenditures</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="kpi-card">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="kpi-icon bg-primary"><i class="fas fa-chart-line"></i></div>
                </div>
                <div class="kpi-label">Net Profit</div>
                <div class="kpi-value">$@Model.TotalProfit.ToString("N2")</div>
                <small class="text-muted">@profitMargin.ToString("N1")% Margin</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="kpi-card">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="kpi-icon bg-info"><i class="fas fa-shopping-cart"></i></div>
                </div>
                <div class="kpi-label">Total Orders</div>
                <div class="kpi-value">@Model.TotalOrders</div>
                <small class="text-muted">All time orders</small>
            </div>
        </div>
    </div>

    <!-- Secondary Metrics -->
    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <i class="fas fa-users text-warning fa-2x me-3"></i>
                <div>
                    <small class="text-muted">Customers</small>
                    <h4 class="mb-0">@Model.TotalCustomers</h4>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <i class="fas fa-box text-purple fa-2x me-3"></i>
                <div>
                    <small class="text-muted">Items</small>
                    <h4 class="mb-0">@Model.TotalItems</h4>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <i class="fas fa-store text-teal fa-2x me-3"></i>
                <div>
                    <small class="text-muted">Branches</small>
                    <h4 class="mb-0">@Model.TotalBranches</h4>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <i class="fas fa-exclamation-triangle text-danger fa-2x me-3"></i>
                <div>
                    <small class="text-muted">Low Stock</small>
                    <h4 class="mb-0">@Model.LowStockItems.Count</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart & Quick Actions -->
    <div class="row g-3 mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Revenue vs Expenses</h5>
                        <small class="text-muted">Last 6 months</small>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a asp-controller="Order" asp-action="Create" class="btn btn-outline-primary">
                            <i class="fas fa-plus me-2"></i>New Order
                        </a>
                        <a asp-controller="Items" asp-action="Create" class="btn btn-outline-primary">
                            <i class="fas fa-box me-2"></i>Add Item
                        </a>
                        <a asp-controller="Customer" asp-action="Create" class="btn btn-outline-primary">
                            <i class="fas fa-user-plus me-2"></i>New Customer
                        </a>
                        <a asp-controller="Expenses" asp-action="Create" asp-route-businessId="@Model.BusinessId" class="btn btn-outline-danger">
                            <i class="fas fa-credit-card me-2"></i>Add Expense
                        </a>
                        <a asp-controller="Report" asp-action="Index" class="btn btn-outline-success">
                            <i class="fas fa-file-invoice me-2"></i>View Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Orders & Expenses -->
    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Orders</h5>
                    <a asp-controller="Order" asp-action="Index" class="btn btn-sm btn-primary">View All</a>
                </div>
                <div class="card-body p-0">
                    @if (Model.RecentOrders.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var order in Model.RecentOrders)
                                    {
                                        <tr>
                                            <td><a asp-controller="Order" asp-action="Details" asp-route-id="@order.Id">#@order.Id</a></td>
                                            <td>@(order.Customer?.FullName ?? "N/A")</td>
                                            <td>@order.datetime.ToString("MMM dd, yyyy")</td>
                                            <td class="text-end text-success fw-bold">$@order.total_amount.ToString("N2")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-center text-muted py-4">No recent orders</p>
                    }
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Expenses</h5>
                    <a asp-controller="Expenses" asp-action="Create" asp-route-businessId="@Model.BusinessId" class="btn btn-sm btn-danger">Add Expense</a>
                </div>
                <div class="card-body p-0">
                    @if (Model.RecentExpenses.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Branch</th>
                                        <th>Date</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var expense in Model.RecentExpenses)
                                    {
                                        <tr>
                                            <td>@(expense.Category ?? "Uncategorized")</td>
                                            <td>@(expense.Branch?.Name ?? "N/A")</td>
                                            <td>@expense.ExpenseDate.ToString("MMM dd, yyyy")</td>
                                            <td class="text-end text-danger fw-bold">$@expense.Amount.ToString("N2")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-center text-muted py-4">No recent expenses</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Top Selling Products -->
    @if (Model.TopSellingItems.Any())
    {
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Top Selling Products</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Units Sold</th>
                                <th class="text-end">Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.TopSellingItems)
                            {
                                <tr>
                                    <td>@item.ItemName</td>
                                    <td><span class="badge bg-info">@item.TotalQuantitySold units</span></td>
                                    <td class="text-end text-success fw-bold">$@item.TotalRevenue.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Low Stock Alerts -->
    @if (Model.LowStockItems.Any())
    {
        <div class="alert alert-warning">
            <h5><i class="fas fa-exclamation-triangle me-2"></i>Low Stock Alerts</h5>
            <div class="row">
                @foreach (var item in Model.LowStockItems)
                {
                    <div class="col-md-4 mb-2">
                        <strong>@item.Item?.Name</strong> - @item.Quantity left (Min: @item.MinStockLevel)
                        <small class="d-block text-muted">@item.Branch?.Name</small>
                    </div>
                }
            </div>
        </div>
    }
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('revenueChart');
        const revenueData = @Html.Raw(Json.Serialize(Model.MonthlyRevenue.Select(m => new { m.MonthName, m.Amount })));
        const expensesData = @Html.Raw(Json.Serialize(Model.MonthlyExpenses.Select(m => new { m.MonthName, m.Amount })));

        const months = [...new Set([...revenueData.map(r => r.monthName), ...expensesData.map(e => e.monthName)])];
        const revenue = months.map(m => revenueData.find(r => r.monthName === m)?.amount || 0);
        const expenses = months.map(m => expensesData.find(e => e.monthName === m)?.amount || 0);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Revenue',
                    data: revenue,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true
                }, {
                    label: 'Expenses',
                    data: expenses,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    </script>
}

<!-- Remove all inline styles - let global CSS handle everything -->