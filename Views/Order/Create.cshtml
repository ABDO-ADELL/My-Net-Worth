@model PRISM.Models.Order

@{
    ViewData["Title"] = "Create Order";
}

<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }

        .page-header h4 {
            color: white;
            margin: 0;
        }

    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }

        .section-header h5 {
            margin: 0;
            color: white;
        }
</style>

<div class="container-fluid mt-4">
    <div class="page-header">
        <h4><i class="fas fa-plus-circle"></i> Create New Order</h4>
    </div>

    <div class="card">
        <div class="card-body">
            <form asp-action="Create" method="post" id="orderForm">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="OrderName" class="form-label">Order Name</label>
                        <input asp-for="OrderName" class="form-control" placeholder="Enter order name" />
                        <span asp-validation-for="OrderName" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="datetime" class="form-label">Order Date & Time</label>
                        <input asp-for="datetime" type="datetime-local" class="form-control" value="@DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm")" />
                        <span asp-validation-for="datetime" class="text-danger"></span>
                        <small class="form-text text-muted">Current UTC time. You can modify if needed.</small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="BusinessId" class="form-label">Business</label>
                        <select asp-for="BusinessId" class="form-select" asp-items="ViewBag.BusinessId" id="businessSelect">
                            <option value="">-- Select Business --</option>
                        </select>
                        <span asp-validation-for="BusinessId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="BranchId" class="form-label">Branch</label>
                        <select asp-for="BranchId" class="form-select" id="branchSelect">
                            <option value="">-- Select Branch --</option>
                        </select>
                        <span asp-validation-for="BranchId" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="CustomerId" class="form-label">Customer</label>
                        <select asp-for="CustomerId" class="form-select" asp-items="ViewBag.CustomerId">
                            <option value="">-- Select Customer --</option>
                        </select>
                        <span asp-validation-for="CustomerId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="status" class="form-label">Status</label>
                        <select asp-for="status" class="form-select">
                            <option value="true" selected>Active</option>
                            <option value="false">Inactive</option>
                        </select>
                        <span asp-validation-for="status" class="text-danger"></span>
                    </div>
                </div>

                <div class="section-header mt-4">
                    <h5><i class="fas fa-shopping-cart"></i> Order Items</h5>
                </div>

                <div class="mb-3">
                    <label class="form-label">Select Item</label>
                    <select id="itemSelect" class="form-select">
                        <option value="">-- Select Item --</option>
                    </select>
                </div>

                <div class="table-responsive mb-4">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Grand Total:</strong></td>
                                <td colspan="2"><strong id="grandTotal">0.00 EGP</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div id="hiddenItemsContainer"></div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Create Order
                    </button>
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        let selectedItems = [];
        let itemsData = @Html.Raw(Json.Serialize(ViewData["Items"]));

        $(document).ready(function () {
            const datetimeInput = $('input[name="datetime"]');
            if (!datetimeInput.val()) {
                const now = new Date();
                const utcNow = new Date(now.getTime() + (now.getTimezoneOffset() * 60000));
                datetimeInput.val(utcNow.toISOString().slice(0, 16));
            }

            loadItemsToDropdown();

            $('#businessSelect').change(function () {
                const businessId = $(this).val();
                $('#branchSelect').html('<option value="">-- Select Branch --</option>');
                $('#itemSelect').html('<option value="">-- Select Item --</option>');
                if (businessId) {
                    $.get('/Order/GetBranchesByBusiness', { businessId: businessId }, function (data) {
                        $.each(data, function (i, branch) {
                            $('#branchSelect').append($('<option></option>').val(branch.branchId).text(branch.name));
                        });
                    });
                }
            });

            $('#branchSelect').change(function () {
                const branchId = $(this).val();
                $('#itemSelect').html('<option value="">-- Select Item --</option>');
                if (branchId) {
                    $.get('/Order/GetItemsByBranch', { branchId: branchId }, function (data) {
                        itemsData = data;
                        loadItemsToDropdown();
                    });
                }
            });

            $('#itemSelect').change(function () {
                const itemId = parseInt($(this).val());
                if (itemId) {
                    const item = itemsData.find(i => i.itemId === itemId);
                    if (item) {
                        addItemToOrder(item);
                        $(this).val('');
                    }
                }
            });
        });

        function loadItemsToDropdown() {
            $('#itemSelect').html('<option value="">-- Select Item --</option>');
            $.each(itemsData, function (i, item) {
                $('#itemSelect').append($('<option></option>').val(item.itemId).text(item.name + ' - ' + item.sellPrice + ' EGP'));
            });
        }

        function addItemToOrder(item) {
            const existingItem = selectedItems.find(i => i.itemId === item.itemId);
            if (existingItem) {
                existingItem.quantity++;
                updateItemRow(existingItem);
            } else {
                selectedItems.push({ itemId: item.itemId, name: item.name, price: item.sellPrice, quantity: 1 });
                addItemRow(selectedItems[selectedItems.length - 1]);
            }
            updateGrandTotal();
            updateHiddenFields();
        }

        function addItemRow(item) {
            $('#itemsTableBody').append(`
                <tr data-item-id="${item.itemId}">
                    <td>${item.name}</td>
                    <td>${item.price.toFixed(2)} EGP</td>
                    <td><input type="number" class="form-control form-control-sm" value="${item.quantity}" min="1" onchange="updateQuantity(${item.itemId}, this.value)"></td>
                    <td class="item-total">${(item.price * item.quantity).toFixed(2)} EGP</td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="removeItem(${item.itemId})"><i class="fas fa-trash"></i></button></td>
                </tr>
            `);
        }

        function updateItemRow(item) {
            const row = $(`tr[data-item-id="${item.itemId}"]`);
            row.find('input').val(item.quantity);
            row.find('.item-total').text((item.price * item.quantity).toFixed(2) + ' EGP');
        }

        function updateQuantity(itemId, newQuantity) {
            const item = selectedItems.find(i => i.itemId === itemId);
            if (item && newQuantity > 0) {
                item.quantity = parseInt(newQuantity);
                updateItemRow(item);
                updateGrandTotal();
                updateHiddenFields();
            }
        }

        function removeItem(itemId) {
            selectedItems = selectedItems.filter(i => i.itemId !== itemId);
            $(`tr[data-item-id="${itemId}"]`).remove();
            updateGrandTotal();
            updateHiddenFields();
        }

        function updateGrandTotal() {
            const total = selectedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            $('#grandTotal').text(total.toFixed(2) + ' EGP');
        }

        function updateHiddenFields() {
            $('#hiddenItemsContainer').empty();
            selectedItems.forEach((item, index) => {
                $('#hiddenItemsContainer').append(`
                    <input type="hidden" name="itemIds[${index}]" value="${item.itemId}" />
                    <input type="hidden" name="quantities[${index}]" value="${item.quantity}" />
                `);
            });
        }
    </script>
}